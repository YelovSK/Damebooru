@if (post(); as pd) {
<div
    class="p-3 relative flex gap-3 lg:h-[calc(100dvh-4rem-1px)] max-[1100px]:h-auto max-[1100px]:flex-col-reverse max-[1100px]:gap-2">
    <!-- Sidebar -->
    <aside
        class="flex h-full w-80 min-w-0 flex-col gap-3 transition-all duration-200 lg:min-w-[350px] max-[1100px]:h-auto max-[1100px]:w-full"
        [class.!w-0]="sidebarCollapsed()" [class.!min-w-0]="sidebarCollapsed()"
        [class.overflow-hidden]="sidebarCollapsed()" [class.opacity-0]="sidebarCollapsed()">

        <!-- Actions Section (always visible at top) -->
        <section class="glass-card p-3 shrink-0">
            @if (around(); as nav) {
            <div class="mb-2 flex gap-2">
                <app-button variant="secondary" size="sm" class="flex-1" [disabled]="!nav.prev"
                    (click)="goToPrevPost()">
                    Previous
                </app-button>
                <app-button variant="secondary" size="sm" class="flex-1" [disabled]="!nav.next"
                    (click)="goToNextPost()">
                    Next
                </app-button>
            </div>
            }

            @if (editService.isEditing()) {
            <div class="flex gap-2">
                <app-button variant="secondary" size="sm" (click)="cancelEditing()" [disabled]="editService.isSaving()"
                    class="flex-1">Cancel</app-button>
                <app-button variant="primary" size="sm" (click)="saveChanges()"
                    [disabled]="editService.isSaving() || !editService.isDirty()" class="flex-1">
                    {{ editService.isSaving() ? 'Saving...' : 'Save Changes' }}
                </app-button>
            </div>
            } @else {
            <app-button variant="secondary" size="sm" (click)="startEditing()" class="w-full">Edit</app-button>
            }
        </section>

        <!-- Tabbed Content -->
        <section class="glass-card p-4 flex-1 min-h-0 flex flex-col">
            <app-simple-tabs>
                <!-- Info Tab (with tags) -->
                <app-simple-tab id="info" label="Info">
                    <div class="grid grid-cols-[100px_1fr] gap-3 text-[0.9rem] mb-4 shrink-0">
                        <span class="text-text-muted">ID</span>
                        <span class="text-text-primary font-medium">#{{ pd.id }}</span>

                        <span class="text-text-muted">Library</span>
                        <span class="text-text-primary font-medium">{{ pd.libraryName || '#' + pd.libraryId }}</span>

                        <span class="text-text-muted">File</span>
                        <span class="text-text-primary font-medium break-all" [appTooltip]="pd.relativePath"
                            tooltipPosition="right">
                            {{ pd.relativePath | fileName }}
                        </span>

                        <span class="text-text-muted">Imported</span>
                        <span class="text-text-primary font-medium">{{ pd.importDate | date:'medium' }}</span>

                        <span class="text-text-muted">File Modified</span>
                        <span class="text-text-primary font-medium">{{ pd.fileModifiedDate | date:'medium' }}</span>

                        <span class="text-text-muted">Size</span>
                        <span class="text-text-primary font-medium">{{ pd.sizeBytes | fileSize }}</span>

                        <span class="text-text-muted">Dimensions</span>
                        <span class="text-text-primary font-medium">{{ pd.width }} x {{ pd.height }}</span>

                        <span class="text-text-muted">Type</span>
                        <span class="text-text-primary font-medium">{{ pd.contentType }}</span>

                    </div>

                    @if (!editService.isEditing()) {
                    <div class="flex flex-row gap-2 mb-4">
                        <app-button [href]="getPostContentUrl(pd)" variant="primary" class="flex-1">
                            Original File
                        </app-button>
                        <app-button variant="secondary" class="flex-1" [class.!bg-status-error/10]="pd.isFavorite"
                            [class.!text-status-error]="pd.isFavorite" [class.!border-status-error/30]="pd.isFavorite"
                            (click)="toggleFavorite()">
                            {{ pd.isFavorite ? 'Unfavorite' : 'Favorite' }}
                        </app-button>
                    </div>
                    }

                    <!-- Tags section within Info tab -->
                    <div class="pt-4 border-t border-white/10 flex flex-col gap-3 flex-1 min-h-0">
                        <h4 class="mt-0 mb-0 text-[0.95rem] text-text-primary font-semibold">Tags</h4>
                        @if (editService.isEditing() && editService.currentState(); as state) {
                        <!-- Tag input -->
                        <app-autocomplete [suggestions]="tagSuggestions()" [multi]="false" [placeholder]="'Add tag...'"
                            [value]="tagSearchValue()" (queryChange)="onTagQueryChange($event)"
                            (selection)="onTagSelection($event)" (searchTrigger)="onTagSearch($event)"
                            (valueChange)="tagSearchValue.set($event)">
                            <ng-template let-tag>
                                <div class="flex justify-between w-full items-center">
                                    <span class="text-accent-primary font-semibold text-[0.8rem]">{{ tag.name }}</span>
                                    <span class="badge text-[0.7rem]">{{ tag.usages | number }}</span>
                                </div>
                            </ng-template>
                        </app-autocomplete>

                        <!-- Editable tag list -->
                        <div class="flex flex-col gap-2 flex-1 min-h-0 overflow-y-auto">
                            @for (tag of state.tags; track trackByEditTag(tag)) {
                            <div
                                class="flex justify-between items-center gap-2 text-[0.85rem] p-2 bg-glass-bg rounded-sm border-l-3 border-l-text-dim">
                                <span
                                    class="text-text-link flex-1 overflow-hidden text-ellipsis whitespace-nowrap min-w-0">{{
                                    tag.name }}</span>
                                <span
                                    class="inline-flex items-center rounded-full border border-white/20 bg-white/5 px-2 py-[0.1rem] text-[0.65rem] uppercase tracking-wide text-text-muted">{{
                                    getTagSourceLabel(tag.source) }}</span>
                                <app-button variant="ghost" size="xs" (click)="removeTag(tag)"
                                    class="text-status-error">×</app-button>
                            </div>
                            }
                        </div>
                        } @else if (pd.tags.length > 0) {
                        <!-- View mode tag list -->
                        <div class="flex flex-col gap-2 flex-1 min-h-0 overflow-y-auto">
                            @for (tag of pd.tags; track trackByTag(tag)) {
                            <a class="flex justify-between items-center gap-2 text-[0.85rem] p-2 bg-glass-bg rounded-sm border-l-3 cursor-pointer transition-all hover:bg-glass-bg-hover"
                                [routerLink]="appLinks.posts()" [queryParams]="{ query: tag.name | tag }"
                                [style.border-left-color]="getTagCategory(tag)?.color || 'var(--color-text-dim)'"
                                [appTooltip]="getTagCategory(tag)?.name || 'Uncategorized'" tooltipPosition="right">
                                <span
                                    class="text-text-link flex-1 overflow-hidden text-ellipsis whitespace-nowrap min-w-0">{{
                                    tag.name }}</span>
                                <div class="flex shrink-0 items-center gap-2">
                                    @if (hasTagSource(tag, postTagSource.Folder)) {
                                    <span
                                        class="inline-flex items-center gap-1 rounded-full border border-amber-300/35 bg-amber-500/10 px-2 py-[0.15rem] text-[0.68rem] font-semibold text-amber-200">
                                        <span>folder</span>
                                    </span>
                                    }
                                    <span class="text-text-dim">{{ tag.usages }}</span>
                                </div>
                            </a>
                            }
                        </div>
                        } @else {
                        <span class="text-text-muted text-[0.85rem]">No tags</span>
                        }
                    </div>
                </app-simple-tab>

                <!-- Source Tab -->
                <app-simple-tab id="source" label="Source">
                    @if (editService.isEditing()) {
                    <textarea [value]="sourcesValue()" (input)="onSourcesChange($event)"
                        placeholder="Sources (one per line)..."
                        class="w-full flex-1 min-h-0 px-3 py-2 bg-glass-bg border border-white/10 rounded-lg text-[0.85rem] text-text-primary placeholder-text-dim resize-none focus:outline-none focus:border-accent-primary/50 focus:ring-1 focus:ring-accent-primary/25"></textarea>
                    } @else if (pd.sources && pd.sources.length > 0) {
                    <div class="flex flex-col gap-2 flex-1 min-h-0 overflow-y-auto">
                        @for (sourceUrl of pd.sources; track sourceUrl) {
                        <a [href]="sourceUrl" target="_blank"
                            class="text-text-link break-all text-[0.85rem] no-underline transition-colors hover:text-text-link-hover hover:underline">{{
                            sourceUrl }}</a>
                        }
                    </div>
                    } @else {
                    <span class="text-text-muted text-[0.85rem]">No sources</span>
                    }
                </app-simple-tab>

                <!-- Similar Tab -->
                <app-simple-tab id="similar" label="Similar">
                    @if (similarPosts().length > 0) {
                    <div class="flex flex-col gap-2 flex-1 min-h-0 overflow-y-auto">
                        @for (similar of similarPosts(); track similar.id) {
                        <a class="flex items-center gap-2 rounded-sm border border-white/10 bg-glass-bg p-2 no-underline transition-colors hover:bg-glass-bg-hover"
                            [routerLink]="appLinks.post(similar.id)" [queryParams]="detailQueryParams()">
                            <img [src]="getSimilarPostThumbnailUrl(similar)" [alt]="similar.relativePath"
                                class="h-14 w-14 shrink-0 rounded object-cover border border-white/10" />
                            <div class="min-w-0 flex-1">
                                <div class="truncate text-[0.82rem] text-text-primary">{{ similar.relativePath | fileName }}</div>
                                <div class="mt-0.5 text-[0.72rem] text-text-muted">
                                    {{ similar.libraryName }} · {{ similar.width }}x{{ similar.height }} · {{ similar.sizeBytes | fileSize }}
                                </div>
                                <div class="mt-1 flex items-center gap-1.5">
                                    <span
                                        [class]="similar.duplicateType === 'exact' ? 'rounded px-1.5 py-0.5 text-[0.65rem] font-semibold bg-blue-600/20 text-blue-300 border border-blue-500/30' : 'rounded px-1.5 py-0.5 text-[0.65rem] font-semibold bg-purple-600/20 text-purple-300 border border-purple-500/30'">
                                        {{ similar.duplicateType === 'exact' ? 'Exact' : 'Perceptual' }}
                                    </span>
                                    @if (similar.similarityPercent !== null) {
                                    <span class="text-[0.68rem] text-text-muted">~{{ similar.similarityPercent }}%</span>
                                    }
                                    @if (similar.groupIsResolved) {
                                    <span class="text-[0.68rem] text-text-muted">resolved group</span>
                                    }
                                </div>
                            </div>
                        </a>
                        }
                    </div>
                    } @else {
                    <span class="text-text-muted text-[0.85rem]">No similar posts found from duplicate groups.</span>
                    }
                </app-simple-tab>

                <!-- Auto-tagging Tab (edit mode only) -->
                <app-simple-tab id="autotag" label="Auto-Tag" [hidden]="!editService.isEditing()">
                    <app-auto-tagging-results [status]="editService.taggingStatus()" [results]="editService.autoTags()"
                        [providers]="registeredProviders()" [showProviderButtons]="true"
                        (runProvider)="triggerProviderAutoTagging($event)" (applyTags)="applyAutoTags($event)"
                        (applySources)="applyAutoSources($event)">
                    </app-auto-tagging-results>
                </app-simple-tab>
            </app-simple-tabs>
        </section>
    </aside>

    <!-- Main Content Area -->
    <div class="relative flex grow items-center justify-center overflow-hidden rounded-xl border border-glass-border bg-[#0a0f1e] min-h-[320px] h-[70vh] sm:min-h-[380px] lg:h-full lg:min-h-0"
        (pointerdown)="onMediaPointerDown($event)" (pointerup)="onMediaPointerUp($event)"
        (pointercancel)="onMediaPointerCancel()">
        <!-- Sidebar Toggle Button -->
        <button type="button"
            class="absolute top-3 left-3 z-10 w-8 h-8 flex items-center justify-center bg-black/50 border border-white/20 rounded-lg text-text-muted hover:text-text-primary hover:bg-black/70 transition-all max-[1100px]:hidden"
            (click)="toggleSidebar()">
            <span class="text-sm">{{ sidebarCollapsed() ? '→' : '←' }}</span>
        </button>

        <app-zoom-pan-container #zoomPan>
            @switch (getMediaType(pd.contentType)) {
            @case ('image')
            @case ('animation') {
            <app-progressive-image [thumbnailSrc]="getThumbnailUrl(pd)"
                [fullSrc]="getPostContentUrl(pd)" [alt]="'' + pd.id" [width]="pd.width"
                [height]="pd.height" />
            }
            @case ('video') {
            <video [src]="getPostContentUrl(pd)" (loadeddata)="imageLoading.set(false)"
                class="w-full h-full object-contain" controls [autoplay]="autoPlayVideos()" [muted]="startVideosMuted()"
                loop></video>
            }
            }
        </app-zoom-pan-container>
    </div>
</div>
} @else {
<div class="flex flex-col items-center justify-center h-full text-text-muted">
    <div
        class="w-[50px] h-[50px] border-3 border-accent-primary-glow border-t-accent-primary rounded-full animate-spin mb-6">
    </div>
    <p>Retrieving post metadata...</p>
</div>
}
