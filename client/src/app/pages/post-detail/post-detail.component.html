@if (post(); as pd) {
<div class="flex gap-3 h-full max-[1100px]:flex-col-reverse max-[1100px]:h-auto max-[1100px]:overflow-y-visible max-[1100px]:gap-2 relative">
    <!-- Sidebar -->
    <aside
        class="w-80 min-w-[350px] h-full flex flex-col gap-3 transition-all duration-200 max-[1100px]:w-full max-[1100px]:h-auto max-[1100px]:mb-8"
        [class.!w-0]="sidebarCollapsed()"
        [class.!min-w-0]="sidebarCollapsed()"
        [class.overflow-hidden]="sidebarCollapsed()"
        [class.opacity-0]="sidebarCollapsed()">

        <!-- Actions Section (always visible at top) -->
        <section class="glass-card p-3 shrink-0">
            @if (editService.isEditing()) {
                <div class="flex gap-2">
                    <app-button variant="secondary" size="sm" (click)="cancelEditing()" [disabled]="editService.isSaving()" class="flex-1">Cancel</app-button>
                    <app-button variant="primary" size="sm" (click)="saveChanges()" [disabled]="editService.isSaving() || !editService.isDirty()" class="flex-1">
                        {{ editService.isSaving() ? 'Saving...' : 'Save Changes' }}
                    </app-button>
                </div>
            } @else {
                <div class="flex gap-2">
                    <app-button variant="secondary" size="sm" (click)="startEditing()" class="flex-1">Edit</app-button>
                    <app-button variant="danger" size="sm" (click)="confirmDelete()" class="flex-1">Delete</app-button>
                </div>
            }
        </section>

        <!-- Tabbed Content -->
        <section class="glass-card p-4 flex-1 min-h-0 flex flex-col">
            <app-simple-tabs>
                <!-- Info Tab (with tags) -->
                <app-simple-tab id="info" label="Info">
                    <div class="grid grid-cols-[100px_1fr] gap-3 text-[0.9rem] mb-4 shrink-0">
                        <span class="text-text-muted">ID</span>
                        <span class="text-text-primary font-medium">#{{ pd.id }}</span>

                        <span class="text-text-muted">Uploader</span>
                        <span class="text-text-primary font-medium">{{ pd.user.name }}</span>

                        <span class="text-text-muted">Created</span>
                        <span class="text-text-primary font-medium">{{ pd.creationTime | date:'medium' }}</span>

                        <span class="text-text-muted">Dimensions</span>
                        <span class="text-text-primary font-medium">{{ pd.canvasWidth }} x {{ pd.canvasHeight }}</span>

                        <span class="text-text-muted">Rating</span>
                        @if (editService.isEditing() && editService.currentState(); as state) {
                            <div class="flex gap-1">
                                @for (s of ['safe', 'sketchy', 'unsafe']; track s) {
                                    <app-button
                                        (click)="setSafety(s)"
                                        [variant]="state.safety === s ? (s === 'safe' ? 'success' : s === 'sketchy' ? 'warning' : 'danger') : 'ghost'"
                                        size="xs"
                                        class="capitalize">
                                        {{ s }}
                                    </app-button>
                                }
                            </div>
                        } @else {
                            <span class="text-text-primary font-medium capitalize" [class.text-status-success]="pd.safety === 'safe'" [class.text-status-warning]="pd.safety === 'sketchy'" [class.text-status-error]="pd.safety === 'unsafe'">{{ pd.safety }}</span>
                        }

                        <span class="text-text-muted">Score</span>
                        <span class="text-status-success font-medium">+{{ pd.score }}</span>
                    </div>

                    @if (!editService.isEditing()) {
                        <div class="flex flex-row gap-2 mb-4">
                            <app-button [href]="environment.mediaBaseUrl + pd.contentUrl" variant="primary" class="flex-1">
                                Original File
                            </app-button>
                            <app-button variant="secondary" class="flex-1"
                                [class.!bg-status-error/10]="pd.ownFavorite"
                                [class.!text-status-error]="pd.ownFavorite"
                                [class.!border-status-error/30]="pd.ownFavorite">
                                {{ pd.ownFavorite ? 'Favorited' : 'Favorites' }}
                            </app-button>
                        </div>
                    }

                    <!-- Tags section within Info tab -->
                    <div class="pt-4 border-t border-white/10 flex flex-col gap-3 flex-1 min-h-0">
                        <h4 class="mt-0 mb-0 text-[0.95rem] text-text-primary font-semibold">Tags</h4>
                        @if (editService.isEditing() && editService.currentState(); as state) {
                            <!-- Tag input -->
                            <app-autocomplete
                                [suggestions]="tagSuggestions()"
                                [multi]="false"
                                [placeholder]="'Add tag...'"
                                [value]="tagSearchValue()"
                                (queryChange)="onTagQueryChange($event)"
                                (selection)="onTagSelection($event)"
                                (searchTrigger)="onTagSearch($event)"
                                (valueChange)="tagSearchValue.set($event)">
                                <ng-template let-tag>
                                    <div class="flex justify-between w-full items-center">
                                        <span class="text-accent-primary font-semibold text-[0.8rem]">{{ tag.names[0] }}</span>
                                        <span class="badge text-[0.7rem]">{{ tag.usages | number }}</span>
                                    </div>
                                </ng-template>
                            </app-autocomplete>

                            <!-- Editable tag list -->
                            <div class="flex flex-col gap-2 flex-1 min-h-0 overflow-y-auto">
                                @for (tag of state.tags; track tag) {
                                    <div class="flex justify-between items-center gap-2 text-[0.85rem] p-2 bg-glass-bg rounded-sm border-l-3 border-l-text-dim">
                                        <span class="text-text-link flex-1 overflow-hidden text-ellipsis whitespace-nowrap min-w-0">{{ tag }}</span>
                                        <app-button variant="ghost" size="xs" (click)="removeTag(tag)" class="text-status-error">×</app-button>
                                    </div>
                                }
                            </div>
                        } @else if (pd.tags.length > 0) {
                            <!-- View mode tag list -->
                            <div class="flex flex-col gap-2 flex-1 min-h-0 overflow-y-auto">
                                @for (tag of pd.tags; track tag.names[0]) {
                                    <a class="flex justify-between items-center gap-2 text-[0.85rem] p-2 bg-glass-bg rounded-sm border-l-3 cursor-pointer transition-all hover:bg-glass-bg-hover" [routerLink]="appLinks.posts()" [queryParams]="{ query: tag.names[0] | tag }"
                                        [style.border-left-color]="getTagCategory(tag)?.color || 'var(--text-dim)'"
                                        [appTooltip]="getTagCategory(tag)?.name || 'Uncategorized'"
                                        tooltipPosition="right">
                                        <span class="text-text-link flex-1 overflow-hidden text-ellipsis whitespace-nowrap min-w-0">{{ tag.names[0] }}</span>
                                        <span class="text-text-dim shrink-0">{{ tag.usages }}</span>
                                    </a>
                                }
                            </div>
                        } @else {
                            <span class="text-text-muted text-[0.85rem]">No tags</span>
                        }
                    </div>
                </app-simple-tab>

                <!-- Source Tab -->
                <app-simple-tab id="source" label="Source">
                    @if (editService.isEditing()) {
                        <textarea
                            [value]="sourcesValue()"
                            (input)="onSourcesChange($event)"
                            placeholder="Sources (one per line)..."
                            class="w-full flex-1 min-h-0 px-3 py-2 bg-glass-bg border border-white/10 rounded-lg text-[0.85rem] text-text-primary placeholder-text-dim resize-none focus:outline-none focus:border-accent-primary/50 focus:ring-1 focus:ring-accent-primary/25"></textarea>
                    } @else if (pd.source) {
                        <div class="flex flex-col gap-2 flex-1 min-h-0 overflow-y-auto">
                            @for (sourceUrl of pd.source.split('\n'); track sourceUrl) {
                                @if (sourceUrl.trim()) {
                                    <a [href]="sourceUrl.trim()" target="_blank" class="text-text-link break-all text-[0.85rem] no-underline transition-colors hover:text-text-link-hover hover:underline">{{ sourceUrl.trim() }}</a>
                                }
                            }
                        </div>
                    } @else {
                        <span class="text-text-muted text-[0.85rem]">No sources</span>
                    }
                </app-simple-tab>

                <!-- Auto-tagging Tab (edit mode only) -->
                <app-simple-tab id="autotag" label="Auto-Tag" [hidden]="!editService.isEditing()">
                    <app-auto-tagging-results
                        [status]="editService.taggingStatus()"
                        [results]="editService.autoTags()"
                        [providers]="registeredProviders()"
                        [showProviderButtons]="true"
                        (runProvider)="triggerProviderAutoTagging($event)"
                        (applyTags)="applyAutoTags($event)"
                        (applySources)="applyAutoSources($event)"
                        (applySafety)="applyAutoSafety($event)">
                    </app-auto-tagging-results>
                </app-simple-tab>
            </app-simple-tabs>
        </section>
    </aside>

    <!-- Main Content Area -->
    <div class="grow flex justify-center items-center bg-[#0a0f1e] rounded-xl overflow-hidden border border-glass-border max-[1100px]:h-[70vh] max-[1100px]:min-h-[400px] max-[1100px]:shrink-0 max-[750px]:h-[60vh] max-[750px]:min-h-[300px] relative">
        <!-- Sidebar Toggle Button -->
        <button
            type="button"
            class="absolute top-3 left-3 z-10 w-8 h-8 flex items-center justify-center bg-black/50 border border-white/20 rounded-lg text-text-muted hover:text-text-primary hover:bg-black/70 transition-all max-[1100px]:hidden"
            (click)="toggleSidebar()">
            <span class="text-sm">{{ sidebarCollapsed() ? '→' : '←' }}</span>
        </button>

        <div class="w-[9999px] h-[9999px] max-w-full max-h-full flex justify-center items-center relative"
             [style.aspect-ratio]="(pd.canvasWidth > 0 && pd.canvasHeight > 0) ? (pd.canvasWidth + '/' + pd.canvasHeight) : null">
            <!-- Thumbnail shown while loading large images, layered behind -->
            @if (pd.fileSize > 3_000_000) {
                <img [src]="environment.mediaBaseUrl + pd.thumbnailUrl" [alt]="pd.id"
                     class="absolute inset-0 w-full h-full object-contain transition-opacity duration-200"
                     [class.opacity-0]="!imageLoading()"
                     decoding="async"
                     [attr.width]="pd.canvasWidth > 0 ? pd.canvasWidth : null"
                     [attr.height]="pd.canvasHeight > 0 ? pd.canvasHeight : null"/>
            }

            @switch (pd.type) {
                @case ('image')
                @case ('animation') {
                <img (load)="imageLoading.set(false)" [src]="environment.mediaBaseUrl + pd.contentUrl" [alt]="pd.id"
                     class="max-w-full max-h-full object-contain transition-opacity duration-200"
                     [class.opacity-0]="imageLoading() && pd.fileSize > 3_000_000"
                     decoding="async"
                     [attr.width]="pd.canvasWidth > 0 ? pd.canvasWidth : null"
                     [attr.height]="pd.canvasHeight > 0 ? pd.canvasHeight : null"/>
                }
                @case ('video') {
                <video [src]="environment.mediaBaseUrl + pd.contentUrl" (loadeddata)="imageLoading.set(false)"
                       class="max-w-full max-h-full object-contain transition-opacity duration-200"
                       [class.opacity-0]="imageLoading() && pd.fileSize > 3_000_000"
                       controls [autoplay]="autoPlayVideos()" [muted]="startVideosMuted()" loop></video>
                }
            }
        </div>
    </div>
</div>
} @else {
<div class="flex flex-col items-center justify-center h-full text-text-muted">
    <div class="w-[50px] h-[50px] border-3 border-accent-primary-glow border-t-accent-primary rounded-full animate-spin mb-6"></div>
    <p>Retrieving post metadata...</p>
</div>
}
