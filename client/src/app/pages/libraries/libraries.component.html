<div class="p-3">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-accent-primary">Libraries</h1>
    </div>

    <section class="glass-card p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
            <span class="w-2 h-6 bg-accent-primary rounded-full"></span>
            Add Library
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-sm text-text-dim mb-1">Name</label>
                <input
                    type="text"
                    [ngModel]="newLibraryName()"
                    (ngModelChange)="newLibraryName.set($event)"
                    placeholder="e.g. Edited Photos"
                    class="w-full px-4 py-2 bg-glass-bg border border-glass-border rounded focus:outline-none focus:ring-2 focus:ring-accent-primary text-text-primary" />
            </div>
            <div>
                <label class="block text-sm text-text-dim mb-1">Server Path</label>
                <input
                    type="text"
                    [ngModel]="newLibraryPath()"
                    (ngModelChange)="newLibraryPath.set($event)"
                    placeholder="/mtn/media/dslr (or C:\Media\Photos)"
                    class="w-full px-4 py-2 bg-glass-bg border border-glass-border rounded focus:outline-none focus:ring-2 focus:ring-accent-primary text-text-primary"
                    (keyup.enter)="createLibrary()" />
            </div>
        </div>

        <div class="flex gap-3 items-center">
            <app-button
                (click)="createLibrary()"
                [disabled]="!newLibraryName().trim() || !newLibraryPath().trim() || isCreating()">
                {{ isCreating() ? 'Creating...' : 'Create Library' }}
            </app-button>
        </div>

        <p class="text-sm text-text-dim mt-3">
            Enter the exact path visible to the server process (container path when running in Docker).
        </p>
    </section>

    <section class="glass-card p-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
            <span class="w-2 h-6 bg-accent-secondary rounded-full"></span>
            Existing Libraries
        </h2>

        <div *ngIf="libraries().length === 0" class="text-text-dim italic">
            No libraries found.
        </div>

        <div class="grid grid-cols-1 gap-4">
            <article
                *ngFor="let lib of libraries()"
                class="p-4 bg-glass-bg rounded border border-glass-border">
                <div class="flex justify-between items-start gap-3">
                    <div class="flex-1">
                        @if (editingLibraryId() === lib.id) {
                            <div class="flex flex-wrap gap-2 items-center">
                                <input
                                    type="text"
                                    [ngModel]="editingName()"
                                    (ngModelChange)="editingName.set($event)"
                                    class="w-full px-3 py-2 bg-glass-bg border border-glass-border rounded focus:outline-none focus:ring-2 focus:ring-accent-primary text-text-primary"
                                    (keyup.enter)="saveRename(lib)" />
                                <app-button size="sm" [disabled]="renamingLibraryId() === lib.id" (click)="saveRename(lib)">
                                    Save
                                </app-button>
                                <app-button size="sm" variant="secondary" (click)="cancelRename()">Cancel</app-button>
                            </div>
                        } @else {
                            <h3 class="text-lg font-semibold text-text-primary">{{ lib.name }}</h3>
                        }
                        <p class="text-sm text-text-dim break-all">{{ lib.path }}</p>
                    </div>
                    <div class="flex flex-wrap justify-end gap-2">
                        <app-button
                            variant="secondary"
                            size="sm"
                            [routerLink]="['/', appPaths.libraries, lib.id, appPaths.libraryExplorer]"
                            [disabled]="editingLibraryId() === lib.id">
                            Browse
                        </app-button>
                        <app-button
                            variant="secondary"
                            size="sm"
                            [disabled]="editingLibraryId() === lib.id"
                            (click)="startRename(lib)">
                            Rename
                        </app-button>
                        <app-button
                            variant="secondary"
                            size="sm"
                            [disabled]="scanningLibraryId() === lib.id || editingLibraryId() === lib.id"
                            (click)="scanLibrary(lib)">
                            {{ scanningLibraryId() === lib.id ? 'Queueing...' : 'Scan' }}
                        </app-button>
                        <app-button
                            variant="danger"
                            size="sm"
                            (click)="deleteLibrary(lib)"
                            [disabled]="isLoading() || editingLibraryId() === lib.id">
                            Delete
                        </app-button>
                    </div>
                </div>

                <div class="mt-4 space-y-2">
                    <div class="flex justify-between items-center py-2 border-b border-white/5">
                        <span class="text-text-muted">Posts</span>
                        <span class="text-[0.95rem] font-semibold">{{ lib.postCount }}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-white/5">
                        <span class="text-text-muted">Total Size</span>
                        <span class="text-[0.95rem] font-semibold">{{ lib.totalSizeBytes | fileSize }}</span>
                    </div>
                    <div class="flex justify-between items-center py-2">
                        <span class="text-text-muted">Last Import</span>
                        <span class="text-[0.9rem] font-medium">{{ lib.lastImportDate ? (lib.lastImportDate | date:'medium') : 'Never' }}</span>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t border-white/10 space-y-3">
                    <div class="text-sm font-semibold text-text-primary">Ignored Paths</div>

                    <div class="flex flex-wrap gap-2 items-center">
                        <input
                            type="text"
                            [ngModel]="getIgnoredPathDraft(lib.id)"
                            (ngModelChange)="setIgnoredPathDraft(lib.id, $event)"
                            placeholder="e.g. _trash or folders/temporary"
                            class="w-full px-3 py-2 bg-glass-bg border border-glass-border rounded focus:outline-none focus:ring-2 focus:ring-accent-primary text-text-primary"
                            (keyup.enter)="addIgnoredPath(lib)" />
                        <app-button
                            size="sm"
                            [disabled]="addingIgnoredPathLibraryId() === lib.id || !getIgnoredPathDraft(lib.id).trim()"
                            (click)="addIgnoredPath(lib)">
                            {{ addingIgnoredPathLibraryId() === lib.id ? 'Adding...' : 'Add' }}
                        </app-button>
                    </div>

                    <div *ngIf="lib.ignoredPaths.length === 0" class="text-sm text-text-dim italic">
                        No ignored paths.
                    </div>

                    <div *ngIf="lib.ignoredPaths.length > 0" class="space-y-2">
                        <div
                            *ngFor="let ignored of lib.ignoredPaths"
                            class="flex items-center justify-between gap-2 px-3 py-2 bg-black/15 rounded border border-white/10">
                            <span class="text-sm break-all">{{ ignored.path }}</span>
                            <app-button
                                variant="danger"
                                size="sm"
                                [disabled]="removingIgnoredPathId() === ignored.id"
                                (click)="removeIgnoredPath(lib, ignored.id, ignored.path)">
                                {{ removingIgnoredPathId() === ignored.id ? 'Removing...' : 'Remove' }}
                            </app-button>
                        </div>
                    </div>
                </div>
            </article>
        </div>
    </section>
</div>
