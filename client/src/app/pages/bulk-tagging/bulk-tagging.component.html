<section class=p-3>
    <header class="mb-6">
        <h1 class="text-2xl font-bold text-text-primary mb-4">Bulk Auto-Tagging</h1>

        <!-- Search with Autocomplete -->
        <div class="max-w-[600px]">
            <app-autocomplete [value]="currentSearchValue()" [suggestions]="tagSuggestions()" [multi]="true"
                placeholder="Search query (e.g., tag-count:0)" (valueChange)="currentSearchValue.set($event)"
                (queryChange)="onQueryChange($event)" (selection)="onSelection($event)"
                (searchTrigger)="onSearch($event)">
                <ng-template let-tag>
                    <div class="flex w-full items-center justify-between gap-3">
                        <span class="truncate text-accent-primary">{{ tag.name }}</span>
                        <span class="badge">{{ tag.usages | number }}</span>
                    </div>
                </ng-template>
            </app-autocomplete>
        </div>
    </header>


    <!-- Controls Bar -->
    <div class="glass-card p-4 mb-6">
        <div class="flex flex-wrap gap-4 items-center justify-between">
            <!-- Selection Controls -->
            <div class="flex flex-wrap gap-2">
                <app-button variant="secondary" size="sm" (click)="selectAll()">Select All</app-button>
                <app-button variant="secondary" size="sm" (click)="selectNone()">Select None</app-button>
                <app-button variant="secondary" size="sm" (click)="selectByState('idle')">Select Idle</app-button>
                <app-button variant="secondary" size="sm" (click)="selectByState('no-results')">Select No
                    Results</app-button>
            </div>

            <!-- Action Controls -->
            <div class="flex flex-wrap gap-2">
                @if (!isTagging() || isPaused()) {
                <app-button variant="primary" size="md" (click)="startTagging()"
                    [disabled]="selectedPosts().size === 0">
                    Start Tagging ({{ selectedPosts().size }})
                </app-button>
                }
                @if (isTagging() && !isPaused()) {
                <app-button variant="secondary" size="md" (click)="pauseTagging()">Pause</app-button>
                }
                @if (isPaused()) {
                <app-button variant="primary" size="md" (click)="resumeTagging()">Resume</app-button>
                }
                @if (isTagging()) {
                <app-button variant="danger" size="md" (click)="cancelTagging()">Cancel</app-button>
                }
                <app-button variant="success" size="md" (click)="applyTagsToAll()" [disabled]="stats().success === 0">
                    Apply All ({{ stats().success }})
                </app-button>
            </div>
        </div>

        <!-- Progress & Stats -->
        <div class="mt-4 pt-4 border-t border-white/10">
            <!-- Currently Processing -->
            @if (isTagging()) {
            <div class="mb-4 p-3 rounded-lg bg-accent-primary/10 border border-accent-primary/30">
                <div class="flex items-center gap-2 text-sm text-accent-primary">
                    <div class="animate-spin w-4 h-4 border-2 border-current border-t-transparent rounded-full"></div>
                    <span class="font-medium">Currently processing:</span>
                    @for (entry of getActivePostIds(); track entry) {
                    <span class="bg-accent-primary/20 px-2 py-0.5 rounded">#{{ entry }}</span>
                    }
                    @if (getActivePostIds().length === 0) {
                    @if (getActiveBackoff(); as backoff) {
                    <span class="text-status-warning">⏳ Rate limited by {{ backoff.apiId }} - retrying in {{
                        (backoff.waitMs / 1000) | number:'1.0-0' }}s</span>
                    } @else {
                    <span class="text-text-muted">Waiting...</span>
                    }
                    }
                </div>
                @if (getQueuedPostIds().length > 0) {
                <div class="mt-2 text-xs text-text-dim">
                    Queued: {{ getQueuedPostIds().slice(0, 10).join(', ') }}
                    @if (getQueuedPostIds().length > 10) {
                    <span>... and {{ getQueuedPostIds().length - 10 }} more</span>
                    }
                </div>
                }
            </div>
            }

            <div class="flex flex-wrap gap-6 text-sm">
                <div class="flex items-center gap-2">
                    <span class="text-text-muted">Total:</span>
                    <span class="font-bold">{{ stats().total }}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-status-success">✅ Success:</span>
                    <span class="font-bold text-status-success">{{ stats().success }}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-status-warning">⚠️ No Results:</span>
                    <span class="font-bold text-status-warning">{{ stats().noResults }}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-status-error">❌ Errors:</span>
                    <span class="font-bold text-status-error">{{ stats().error }}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-text-muted">⏳ Pending:</span>
                    <span class="font-bold">{{ stats().pending }}</span>
                </div>
            </div>

            <!-- Rate Limiter Status -->
            <div class="mt-3 flex flex-wrap gap-4 text-xs text-text-dim">
                @for (apiId of ['saucenao', 'danbooru', 'gelbooru']; track apiId) {
                @if (rateLimiterStatuses()[apiId]; as status) {
                <div class="flex items-center gap-1">
                    <span class="capitalize">{{ apiId }}:</span>
                    @if (status.inBackoff) {
                    <span class="text-status-error">Backoff ({{ (status.waitMs / 1000).toFixed(0) }}s)</span>
                    } @else {
                    <span class="text-status-success">Ready</span>
                    }
                </div>
                }
                }
            </div>
        </div>
    </div>

    <!-- Posts Grid -->
    @if (postsState(); as state) {
    @if (state.isLoading) {
    <div class="text-center py-12">
        <div class="animate-spin w-8 h-8 border-2 border-accent-primary border-t-transparent rounded-full mx-auto">
        </div>
        <p class="text-text-muted mt-4">Loading posts...</p>
    </div>
    } @else if (state.error) {
    <div class="glass-card p-8 text-center text-status-error">
        Failed to load posts. Please try again.
    </div>
    } @else if (state.data) {
    @if (state.data.items.length === 0) {
    <div class="glass-card p-8 text-center text-text-muted">
        No posts found matching your query.
    </div>
    } @else {
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3">
        @for (post of state.data.items; track post.id) {
        @if (postStatuses().get(post.id); as status) {
        <div class="relative rounded-lg overflow-hidden bg-bg-secondary cursor-pointer transition-all border-l-4 hover:scale-105 hover:z-10"
            [class]="getStateClass(status.state)" [class.ring-2]="isSelected(post.id)"
            [class.ring-accent-primary]="isSelected(post.id)" (click)="toggleSelect(post.id)">

            <!-- Thumbnail -->
            <div class="aspect-square">
                <img [src]="getThumbnailUrl(post)" [alt]="'Post ' + post.id"
                    class="w-full h-full object-cover" loading="lazy" />
            </div>

            <!-- Status Overlay - Queued -->
            @if (status.state === 'queued') {
            <div class="absolute inset-0 bg-yellow-500/40 flex items-center justify-center">
                <div class="bg-black/70 px-3 py-2 rounded-lg text-sm font-medium text-yellow-300">
                    ⏳ QUEUED
                </div>
            </div>
            }

            <!-- Status Overlay - Tagging -->
            @if (status.state === 'tagging') {
            <div class="absolute inset-0 bg-blue-500/40 flex items-center justify-center">
                <div class="bg-black/70 px-3 py-2 rounded-lg flex items-center gap-2 text-sm font-medium text-blue-300">
                    <div class="animate-spin w-4 h-4 border-2 border-current border-t-transparent rounded-full"></div>
                    TAGGING
                </div>
            </div>
            }

            <!-- Status Overlay - Error -->
            @if (status.state === 'error') {
            <div class="absolute inset-0 bg-red-500/40 flex items-center justify-center">
                <div class="bg-black/70 px-3 py-2 rounded-lg text-sm font-medium text-red-300">
                    ❌ ERROR
                </div>
            </div>
            }

            <!-- Selection Checkbox -->
            <div class="absolute top-2 left-2">
                <app-form-checkbox [ngModel]="isSelected(post.id)" (ngModelChange)="toggleSelect(post.id)"
                    id="bulk-select-{{post.id}}" (click)="$event.stopPropagation()"></app-form-checkbox>
            </div>

            <!-- Post Info -->
            <div class="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black/80 to-transparent">
                <div class="flex justify-between items-center text-xs">
                    <span class="font-bold text-white">#{{ post.id }}</span>
                    @if (status.state === 'success' || status.state === 'applied') {
                    <span class="text-status-success font-medium">
                        @if (status.result?.results; as results) {
                        @if (getTotalTagCount(results) > 0) {
                        ✅ {{ getTotalTagCount(results) }} tags
                        }
                        }
                    </span>
                    }
                    @if (status.state === 'no-results') {
                    <span class="text-status-warning font-medium">⚠️ No matches</span>
                    }
                </div>
            </div>

            <!-- Apply Button (for success state) -->
            @if (status.state === 'success') {
            <div
                class="absolute inset-0 bg-black/50 opacity-0 hover:opacity-100 transition-opacity flex items-center justify-center">
                <app-button variant="success" size="sm" (click)="applyTagsToPost(post.id); $event.stopPropagation()">
                    Apply Tags
                </app-button>
            </div>
            }
        </div>
        }
        }
    </div>

    <!-- Pagination -->
    @if (totalPages() > 1) {
    <div class="mt-8 flex justify-center">
        <app-paginator [currentPage]="currentPage()" [totalPages]="totalPages()" (pageChange)="onPageChange($event)">
        </app-paginator>
    </div>
    }
    }
    }
    }
</section>
