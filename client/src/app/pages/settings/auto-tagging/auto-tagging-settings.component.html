<div>
  <h2 class="text-2xl font-bold text-text-secondary mb-2">Auto-Tagging Settings</h2>
  <p class="text-text-muted mb-4">Configure your automatic tagging providers.</p>

  <div
    class="bg-status-warning/10 border border-status-warning/30 text-status-warning px-4 py-3 rounded-md mb-4 text-sm">
    <strong>Note:</strong> API keys are stored in your browser's local storage.
  </div>

  <div class="bg-accent-primary/10 border border-accent-primary/20 text-text-muted px-4 py-3 rounded-md mb-6 text-sm">
    <strong class="text-accent-primary">Where to get API keys:</strong>
    <ul class="mt-2 space-y-1 list-disc list-inside">
      <li><a href="https://saucenao.com/user.php?page=search-api" target="_blank"
          class="text-accent-primary hover:underline">SauceNAO</a></li>
      <li><a href="https://gelbooru.com/index.php?page=account&s=options" target="_blank"
          class="text-accent-primary hover:underline">Gelbooru</a></li>
      <li><a href="https://danbooru.donmai.us/profile" target="_blank"
          class="text-accent-primary hover:underline">Danbooru</a></li>
    </ul>
  </div>

  @if (providers().length === 0) {
  <div class="bg-accent-primary/10 border border-accent-primary/20 text-accent-primary px-4 py-3 rounded-md">
    No auto-tagging providers registered.
  </div>
  }

  @for (provider of providers(); track provider.id) {
  @let form = getFormGroup(provider.id);
  <div class="bg-bg-secondary border rounded-lg overflow-hidden mb-4 shadow-glass transition-colors"
    [class.border-glass-border]="!form?.dirty" [class.border-accent-primary/50]="form?.dirty">
    <app-collapsible [title]="provider.name" [(expanded)]="expandedProviders[provider.id]">
      <ng-container header>
        <div class="flex items-center gap-4 ml-auto">
          <!-- Enable/Disable Toggle -->
          <button type="button"
            class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors focus:outline-none focus:ring-2 focus:ring-accent-primary/50"
            [class.bg-accent-primary]="isProviderEnabled(provider.id)"
            [class.bg-gray-600]="!isProviderEnabled(provider.id)"
            (click)="toggleProviderEnabled(provider.id); $event.stopPropagation()">
            <span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform"
              [class.translate-x-6]="isProviderEnabled(provider.id)"
              [class.translate-x-1]="!isProviderEnabled(provider.id)"></span>
          </button>
          <span class="text-xs" [class.text-accent-primary]="isProviderEnabled(provider.id)"
            [class.text-text-muted]="!isProviderEnabled(provider.id)">
            {{ isProviderEnabled(provider.id) ? 'Enabled' : 'Disabled' }}
          </span>
          <span
            class="bg-white/10 text-text-muted text-xs font-medium px-2.5 py-0.5 rounded border border-glass-border">
            Priority: {{ provider.priority }}
          </span>
          @if (form?.dirty) {
          <span class="text-accent-primary text-xs font-semibold animate-pulse">
            Unsaved Changes
          </span>
          }
        </div>
      </ng-container>
      @if (provider.getSettingsSchema().length === 0) {
      <div class="text-text-muted italic">
        This provider has no configurable settings.
      </div>
      }

      @if (form) {
      <div [formGroup]="form" class="space-y-4">
        <div class="space-y-6">
          @for (schema of provider.getSettingsSchema(); track schema.key) {
          @if (isSettingVisible(provider.id, schema.key)) {
          <div class="p-2 border-b border-glass-border last:border-0 pb-6 last:pb-2">
            <label [for]="schema.key" class="block font-semibold mb-1 text-text-secondary">{{ schema.label }}</label>
            @if (schema.description) {
            <div class="text-[0.85rem] text-text-muted mb-4">
              {{ schema.description }}
            </div>
            }

            @switch (schema.type) {
            @case ('boolean') {
            <app-form-checkbox [id]="schema.key" [formControlName]="schema.key" [label]="schema.label" />
            }

            @case ('number') {
            <app-form-number-input [id]="schema.key" [formControlName]="schema.key" [label]="schema.label" />
            }

            @default {
            <app-form-input [id]="schema.key" [formControlName]="schema.key" [label]="schema.label" />
            }
            }
          </div>
          }
          }
        </div>

        <div class="flex justify-end pt-4 border-t border-glass-border/50">
          <app-button type="button" (click)="saveSettings(provider)" [disabled]="!form.dirty || form.invalid"
            variant="primary">
            Save Settings
          </app-button>
        </div>
      </div>
      }
    </app-collapsible>
  </div>
  }
</div>
