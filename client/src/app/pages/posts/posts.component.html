<section class="relative w-full">
    <header #toolbar
        class="posts-toolbar absolute top-0 right-0 left-0 z-40 m-3 mb-0 overflow-visible rounded-[0.8rem] border border-glass-border bg-bg-secondary px-[0.6rem] py-2 shadow-none transition-[transform,opacity,border-color] duration-200 md:sticky md:top-0 md:z-30 md:mb-3 md:rounded-xl md:px-3 md:py-3 lg:px-4"
        [class.posts-toolbar-hidden]="toolbarHidden()">
        <div class="flex flex-col gap-[0.55rem] md:gap-3 lg:flex-row lg:items-center lg:justify-between">
            <div class="relative z-20 w-full lg:max-w-[560px]">
                <app-autocomplete [value]="currentSearchValue()" [suggestions]="tagSuggestions()" [multi]="true"
                    [focusShortcut]="{ modifier: null, key: '/' }" placeholder="Search posts..."
                    (queryChange)="onQueryChange($event)" (selection)="onSelection($event)"
                    (searchTrigger)="onSearch($event)" (valueChange)="currentSearchValue.set($event)">
                    <ng-template let-tag>
                        <div class="flex w-full items-center justify-between gap-3">
                            <span class="truncate text-accent-primary">{{ tag.name }}</span>
                            <span class="badge">{{ tag.usages | number }}</span>
                        </div>
                    </ng-template>
                </app-autocomplete>
            </div>

            <div
                class="flex w-full min-w-0 flex-nowrap items-stretch justify-between gap-1.5 lg:w-auto lg:flex-wrap lg:items-center lg:justify-end lg:gap-2">
                <div
                    class="inline-flex h-[1.9rem] min-h-[1.9rem] flex-none items-center gap-1 rounded-lg border border-glass-border bg-bg-primary p-[0.2rem] box-border md:h-[2.05rem] md:min-h-[2.05rem] md:gap-2 md:p-0">
                    @for (densityOption of densityOptions; track densityOption.value) {
                    <button type="button"
                        class="inline-flex h-full items-center justify-center whitespace-nowrap rounded-[0.45rem] border border-transparent bg-transparent px-[0.56rem] text-[0.72rem] font-semibold text-text-muted transition-all duration-150 hover:bg-white/5 hover:text-text-primary md:rounded-[0.55rem] md:px-[0.72rem] md:text-[0.76rem]"
                        [style.backgroundColor]="isDensitySelected(densityOption.value) ? 'rgba(56, 189, 248, 0.22)' : null"
                        [style.borderColor]="isDensitySelected(densityOption.value) ? 'rgba(56, 189, 248, 0.52)' : null"
                        [style.color]="isDensitySelected(densityOption.value) ? 'var(--color-accent-primary)' : null"
                        [style.boxShadow]="isDensitySelected(densityOption.value) ? '0 0 0 1px rgba(56, 189, 248, 0.18) inset' : null"
                        (click)="onDensitySelect(densityOption.value)">
                        {{ densityOption.label }}
                    </button>
                    }
                </div>

                <div
                    class="inline-flex h-[1.9rem] min-h-[1.9rem] flex-none items-center overflow-hidden whitespace-nowrap rounded-[0.7rem] border border-glass-border bg-bg-primary px-[0.56rem] text-[0.74rem] font-semibold text-text-muted text-ellipsis box-border md:h-[2.05rem] md:min-h-[2.05rem] md:px-[0.7rem] md:text-[0.8rem]">
                    @if (totalCount() !== null) {
                    <span>{{ totalCount()! | number }} posts</span>
                    } @else {
                    <span>Loading...</span>
                    }
                </div>
            </div>
        </div>
    </header>

    @if (hasNoResults()) {
    <div class="rounded-xl border border-glass-border bg-glass-bg p-10 text-center text-text-muted">
        No posts match your search.
    </div>
    }

    <div #viewportShell class="posts-viewport-shell relative min-h-[260px] px-3"
        [class.posts-scrolling]="isScrolling() || fastScrollerDragging()" [class.hidden]="hasNoResults()"
        [style.paddingTop.px]="mobileToolbarInsetPx()">

        <cdk-virtual-scroll-viewport #postsViewport
            class="posts-virtual-viewport h-full w-full overflow-auto overscroll-contain pr-[0.2rem] [overflow-anchor:none] [scrollbar-width:none]"
            [itemSize]="rowItemHeightPx()" [minBufferPx]="rowItemHeightPx() * virtualMinBufferRows()"
            [maxBufferPx]="rowItemHeightPx() * virtualMaxBufferRows()" [style.height.px]="viewportHeightPx()">

            <div class="virtual-row relative flex w-full items-stretch box-border contain-strict"
                *cdkVirtualFor="let _rowItem of virtualRowDataSource; let rowIndex = index; trackBy: trackVirtualRow"
                [style.height.px]="getRowHeightPx(rowIndex)" [class.items-center]="isSeparatorRow(rowIndex)">
                <div class="grid h-full w-full box-border content-start"
                    [style.gridTemplateColumns]="gridTemplateColumns()" [style.columnGap.px]="gridGapPx"
                    [style.paddingTop.px]="gridGapPx / 2" [style.paddingBottom.px]="gridGapPx / 2">
                    @for (cell of getRowCells(rowIndex); track $index) {
                    @if (cell.kind === 'post') {
                    @if (cell.post; as post) {
                    <app-post-tile [post]="post" [queryParams]="activeQueryParams()" />
                    }
                    } @else if (cell.kind === 'skeleton') {
                    <div class="aspect-square rounded-xl border border-slate-400/18 bg-[#22324a]">
                    </div>
                    } @else {
                    <!-- Leave this empty -->
                    }
                    }
                </div>
            </div>
        </cdk-virtual-scroll-viewport>

        <div class="fast-scroller-hover-zone" aria-hidden="true">
        </div>

        <div #fastScrollerRail class="fast-scroller-rail" [class.fast-scroller-visible]="fastScrollerVisible()"
            [class.fast-scroller-dragging]="fastScrollerDragging()">
            <div class="fast-scroller-thumb absolute top-0 left-1/2 w-[6px] -translate-x-1/2 rounded-full bg-gradient-to-b from-sky-400/95 to-sky-500/95 shadow-[0_5px_14px_rgba(2,132,199,0.42)]"
                [style.height.px]="fastScrollerThumbHeightPx()"
                [style.transform]="'translateY(' + fastScrollerThumbTopPx() + 'px)'">
            </div>
        </div>

        @if (showFastScrollerBubble()) {
        <div class="pointer-events-none absolute top-0 right-[31px] z-[36] inline-flex h-9 min-w-[74px] items-center justify-center whitespace-nowrap rounded-full border border-sky-300/45 bg-slate-900/92 px-[0.72rem] text-[0.74rem] font-bold text-text-secondary"
            [style.transform]="'translateY(' + fastScrollerBubbleTopPx() + 'px)'">
            Page {{ fastScrollerBubblePage() }}
        </div>
        }
    </div>

    @if (previewPost(); as preview) {
    <app-post-preview-overlay [post]="preview" (closed)="previewPost.set(null)" />
    }
</section>
