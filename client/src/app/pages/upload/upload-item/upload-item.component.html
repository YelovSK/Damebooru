@if (item(); as item) {
<div
  class="glass-card flex border-l-4 transition-all duration-200 min-h-[180px] relative z-1 group hover:bg-glass-bg-hover hover:shadow-2xl focus-within:z-100 focus-within:bg-glass-bg-hover focus-within:shadow-2xl"
  [class.border-l-accent-primary]="item.status === 'uploading'"
  [class.border-l-status-warning]="item.status === 'processing'"
  [class.border-l-status-success]="item.status === 'completed'" [class.border-l-status-error]="item.status === 'failed'"
  [class.border-l-text-dim]="item.status === 'cancelled'" [class.opacity-80]="item.status === 'cancelled'">

  <!-- Preview Section -->
  <div
    class="w-[180px] h-[180px] shrink-0 bg-bg-tertiary relative border-r border-white/5 overflow-hidden rounded-l-[calc(var(--border-radius-xl)-4px)]">
    @if (item.file.type.startsWith('video/')) {
    <video [src]="item.previewUrl" class="w-full h-full object-cover" muted></video>
    } @else {
    <img [src]="item.previewUrl" alt="Upload preview" class="w-full h-full object-cover" />
    }

    @if (item.status !== 'completed') {
    <div class="absolute inset-0 bg-black/60 flex flex-col justify-center items-center gap-2">
      @if (item.status === 'uploading') {
      <app-progress-bar class="w-4/5" [progress]="item.progress" [heightClass]="'h-1'" [trackClass]="'bg-white/10'" [fillClass]="'bg-accent-primary'"></app-progress-bar>
      }
      <span class="text-[0.7rem] uppercase font-bold tracking-wider text-white">{{ item.status }}</span>
    </div>
    }

    @if (item.status === 'completed') {
    <div class="absolute inset-0 bg-status-success/10 flex justify-center items-center">
      <i class="text-5xl text-status-success shadow-[0_0_20px_rgba(34,197,94,0.4)]">✓</i>
    </div>
    }
  </div>

  <!-- Info Section -->
  <div class="grow flex flex-col p-4 min-w-0">
    <div class="flex justify-between items-center mb-3">
      <div class="flex flex-col overflow-hidden">
        <span class="font-bold text-text-primary overflow-hidden text-ellipsis whitespace-nowrap text-sm"
          [title]="item.file.name">
          {{ item.file.name }}
        </span>
        @if (item.duplicateOf?.id; as duplicateId) {
        <span class="text-status-error text-[0.7rem] font-bold">
          Duplicate of <a [routerLink]="appLinks.post(duplicateId)" class="underline">#{{ duplicateId }}</a>
        </span>
        }
        @if (item.checkingDuplicate) {
        <span class="text-text-muted text-[0.7rem] animate-pulse">Checking duplicates...</span>
        }
      </div>
      <app-button variant="ghost" (click)="removeMe()" size="icon" title="Remove">×</app-button>
    </div>

    <!-- Tags Management -->
    <div class="grow flex flex-col gap-3 min-h-0">
      <div class="relative z-20">
        <app-autocomplete [suggestions]="tagSuggestions()" [multi]="true" [placeholder]="'Add tags...'"
          [value]="currentSearchValue()" (queryChange)="onTagQueryChange($event)" (selection)="onTagSelection($event)"
          (searchTrigger)="onSearch($event)" (valueChange)="currentSearchValue.set($event)">
          <ng-template let-tag>
            <div class="flex justify-between w-full items-center">
              <span class="text-accent-primary font-semibold text-[0.8rem]">{{ tag.names[0] }}</span>
              <span class="badge text-[0.7rem]">{{ tag.usages | number }}</span>
            </div>
          </ng-template>
        </app-autocomplete>
      </div>

      <!-- Sources -->
      <div class="relative">
        <textarea [value]="currentSourcesValue()" (input)="onSourcesChange($event)"
          placeholder="Sources (one per line)..." rows="2"
          class="w-full px-3 py-2 bg-glass-bg border border-white/10 rounded-lg text-[0.8rem] text-text-primary placeholder-text-dim resize-none focus:outline-none focus:border-accent-primary/50 focus:ring-1 focus:ring-accent-primary/25"></textarea>
      </div>

      <!-- Auto-tagging suggestions -->
      <div class="p-2 bg-white/5 rounded-lg border border-white/5">
        <app-auto-tagging-results [status]="item.taggingStatus()" [results]="item.autoTags()"
          [providers]="registeredProviders()" [showProviderButtons]="true" [rateLimiterStatuses]="rateLimiterStatuses()"
          (runProvider)="triggerProviderAutoTagging($event)" (applyTags)="applyAutoTags($event)"
          (applySources)="applyAutoSources($event)" (applySafety)="applyAutoSafety($event)">
        </app-auto-tagging-results>
      </div>
    </div>

    <!-- Actions & Safety -->
    <div class="flex justify-between items-center mt-3">
      <div class="flex gap-1 bg-black/20 p-1 rounded-lg border border-white/5">
        @for (s of ['safe', 'sketchy', 'unsafe']; track s) {
        <app-button (click)="setSafety(s)"
          [variant]="item.safety === s ? (s === 'safe' ? 'success' : s === 'sketchy' ? 'warning' : 'danger') : 'ghost'"
          size="xs" [class.text-white]="item.safety === s" [class.text-text-dim]="item.safety !== s" class="capitalize"
          [class.shadow-[0_0_10px_rgba(34,197,94,0.3)]]="item.safety === s && s === 'safe'"
          [class.shadow-[0_0_10px_rgba(245,158,11,0.3)]]="item.safety === s && s === 'sketchy'"
          [class.shadow-[0_0_10px_rgba(239,68,68,0.3)]]="item.safety === s && s === 'unsafe'">
          {{ s }}
        </app-button>
        }
      </div>

      <div class="flex gap-2">
        @if (item.status === 'pending') {
        <app-button (click)="startUpload()" variant="primary" size="sm">Upload</app-button>
        }
        @if (item.status === 'failed') {
        <app-button (click)="retry()" variant="primary" size="sm">Retry</app-button>
        }
        @if (item.status === 'uploading' || item.status === 'processing') {
        <app-button (click)="cancel()" variant="secondary" size="sm">Cancel</app-button>
        }
        @if (item.status === 'completed' && item.post?.id; as postId) {
        <app-button [routerLink]="appLinks.post(postId)" variant="secondary" size="sm">View Post</app-button>
        }
      </div>
    </div>

    @if (item.error) {
    <div class="text-status-error text-[0.7rem] mt-1 font-medium">
      {{ item.error }}
    </div>
    }
  </div>
</div>
}
